<!DOCTYPE html>
<html>
<head>
    <title>CART</title>
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/css/style-cart.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,900" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="CartContainer">
    <div class="Header">
        <h3 class="Heading">Cart</h3>
        <a href="{{ url_for('order_page') }}" class="back">
            <span>Back to Order</span>
        </a>
    </div>

    {% for cart_item in cart_items %}
        {% set item = cart_item.item_info %}
        <div class="Cart-Items" data-item-id="{{ item.item_id }}">
            <div class="image-box">
                <img src="{{ url_for('static', filename='styles/img/' + item.source) }}"
                     alt="{{ item.name }}" class="menu__img">
            </div>

            <div class="about">
                <h1 class="title truncate">{{ item.name }}</h1>
                <p class="subtitle truncate">{{ item.description }}</p>
            </div>

            <div class="counter">
                <button class="btn decrease-btn" data-item-id="{{ item.item_id }}">-</button>
                <div class="count" data-item-id="{{ item.item_id }}">{{ cart_item.item_qty }}</div>
                <button class="btn increase-btn" data-item-id="{{ item.item_id }}">+</button>
            </div>

            <div class="prices">
                <div class="amount">${{ item.price }} each</div>
                <button class="remove remove-item" data-item-id="{{ item.item_id }}">Remove</button>
            </div>
        </div>
    {% endfor %}

    <div class="checkout">
        <div class="total">
        <div class="total">
            <div class="Subtotal">Sub-Total of </div>
            <div class="Subtotal"> {{ cart_items | sum(attribute='item_qty') }} items:  </div>
            <div class="total-amount">${{ total_price | round(2) }}</div>
        </div>
        {% if error_message %}
        <div class="error-message">
            {{ error_message }}
        </div>
    {% endif %}
        <form method="POST">
            <button type="submit" class="button">Place Order</button>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Increase or decrease quantity
        $('.increase-btn, .decrease-btn').on('click', function () {
            var itemId = $(this).data('item-id');
            var action = $(this).hasClass('increase-btn') ? 'increase' : 'decrease';

            $.ajax({
                url: "{{ url_for('modify_cart') }}",
                method: 'POST',
                data: {
                    item_id: itemId,
                    action: action
                },
                success: function (response) {
                    // Update total items
                    $('.items').text(response.total_items + ' items');

                    // Update total price
                    $('.total-amount').text('$' + response.total_price.toFixed(2));

                    // Update specific item quantity
                    $(".count[data-item-id='" + itemId + "']").text(response.item_quantity);
                },
                error: function (xhr) {
                    displayError('Error modifying cart: ' + xhr.responseJSON.error);
                }
            });
        });

        // Remove item from cart
        $('.remove-item').on('click', function () {
            const itemId = $(this).data('item-id');

            fetch("{{ url_for('remove_cart_item') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `item_id=${itemId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    displayError(data.error);
                } else {
                    // Remove the item from the DOM
                    $(this).closest('.Cart-Items').remove();

                    // Update total items and price
                    $('.items').text(data.total_items + ' items');
                    $('.total-amount').text('$' + data.total_price.toFixed(2));
                }
            })
            .catch(error => {
                displayError('An error occurred while removing the item.');
            });
        });

        // Function to display error messages in the error-message div
        function displayError(message) {
            const errorMessageDiv = document.querySelector('.error-message');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
            }
        }
    });
</script>


</body>
</html>