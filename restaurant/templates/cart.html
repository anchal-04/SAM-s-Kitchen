<!DOCTYPE html>
<html>
<head>
    <title>CART</title>
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/css/style-cart.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700,900" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="CartContainer">
    <div class="Header">
        <h3 class="Heading">Cart</h3>
        <a href="{{ url_for('order_page') }}" class="back">
            <span>Back to Order</span>
        </a>
    </div>

    {% for cart_item in cart_items %}
        {% set item = cart_item.item_info %}
        <div class="Cart-Items" data-item-id="{{ item.item_id }}">
            <div class="image-box">
                <img src="{{ url_for('static', filename='styles/img/' + item.source) }}"
                     alt="{{ item.name }}" class="menu__img">
            </div>

            <div class="about">
                <h1 class="title truncate">{{ item.name }}</h1>
                <p class="subtitle truncate">{{ item.description }}</p>
            </div>

            <div class="counter">
                <button class="btn decrease-btn" data-item-id="{{ item.item_id }}">-</button>
                <div class="count" data-item-id="{{ item.item_id }}">{{ cart_item.item_qty }}</div>
                <button class="btn increase-btn" data-item-id="{{ item.item_id }}">+</button>
            </div>

            <div class="prices">
                <div class="amount">${{ item.price }}</div>
                <div class="remove">Remove</div>
            </div>
        </div>
    {% endfor %}

    <div class="checkout">
        <div class="total">
            <div class="Subtotal">Sub-Total</div>
            <div class="items">{{ cart_items | sum(attribute='item_qty') }} items</div>
            <div class="total-amount">${{ total_price | round(2) }}</div>
        </div>
        {% if error_message %}
        <div class="error-message">
            {{ error_message }}
        </div>
    {% endif %}
        <form method="POST">
            <button type="submit" class="button">Place Order</button>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.increase-btn, .decrease-btn').on('click', function () {
            var itemId = $(this).data('item-id');
            var action = $(this).hasClass('increase-btn') ? 'increase' : 'decrease';

            $.ajax({
                url: "{{ url_for('modify_cart') }}",
                method: 'POST',
                data: {
                    item_id: itemId,
                    action: action
                },
                success: function (response) {
                    // Update total items
                    $('.items').text(response.total_items + ' items');

                    // Update total price
                    $('.total-amount').text('$' + response.total_price.toFixed(2));

                    // Update specific item quantity
                    $(".count[data-item-id='" + itemId + "']").text(response.item_quantity);
                },
                error: function (xhr) {
                    alert('Error modifying cart: ' + xhr.responseJSON.error);
                }
            });
        });
    });
</script>

</body>
</html>